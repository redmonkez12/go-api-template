name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Build API
        run: go build ./cmd/api/...

      - name: Build CLI
        run: go build ./cmd/cli/...

      - name: Run tests
        run: go test -race ./...

      - name: Vet
        run: go vet ./...

  generate-variants:
    name: "Generate: ${{ matrix.database }}+${{ matrix.orm }}+${{ matrix.auth }}"
    runs-on: ubuntu-latest
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          # PostgreSQL variants
          - { database: postgres, orm: bun, auth: paseto }
          - { database: postgres, orm: bun, auth: jwt }
          - { database: postgres, orm: gorm, auth: paseto }
          - { database: postgres, orm: gorm, auth: jwt }
          - { database: postgres, orm: pgx, auth: paseto }
          - { database: postgres, orm: pgx, auth: jwt }
          # MySQL variants
          - { database: mysql, orm: gorm, auth: paseto }
          - { database: mysql, orm: gorm, auth: jwt }
          - { database: mysql, orm: bun, auth: paseto }
          - { database: mysql, orm: bun, auth: jwt }
          - { database: mysql, orm: sqlraw, auth: paseto }
          - { database: mysql, orm: sqlraw, auth: jwt }
          # MongoDB variants
          - { database: mongodb, orm: mongo, auth: paseto }
          - { database: mongodb, orm: mongo, auth: jwt }
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Build CLI
        run: go build -o bin/create-go-api ./cmd/cli/

      - name: Generate project
        run: |
          ./bin/create-go-api create \
            --name test-project \
            --module github.com/test/test-project \
            --database ${{ matrix.database }} \
            --orm ${{ matrix.orm }} \
            --auth ${{ matrix.auth }}

      - name: Build generated project
        working-directory: test-project
        run: go build ./...

      - name: Vet generated project
        working-directory: test-project
        run: go vet ./...
