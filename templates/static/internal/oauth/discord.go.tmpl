package oauth

import (
	"context"
	"encoding/json"
	"fmt"
	"io"
	"net/http"

	"golang.org/x/oauth2"
)

var discordEndpoint = oauth2.Endpoint{
	AuthURL:  "https://discord.com/api/oauth2/authorize",
	TokenURL: "https://discord.com/api/oauth2/token",
}

// DiscordProvider implements OAuth for Discord.
type DiscordProvider struct {
	config *oauth2.Config
}

// NewDiscordProvider creates a new Discord OAuth provider.
func NewDiscordProvider(clientID, clientSecret, redirectURL string) *DiscordProvider {
	return &DiscordProvider{
		config: &oauth2.Config{
			ClientID:     clientID,
			ClientSecret: clientSecret,
			RedirectURL:  redirectURL,
			Scopes:       []string{"identify", "email"},
			Endpoint:     discordEndpoint,
		},
	}
}

func (d *DiscordProvider) Name() string {
	return "discord"
}

func (d *DiscordProvider) AuthCodeURL(state string) string {
	return d.config.AuthCodeURL(state)
}

func (d *DiscordProvider) Exchange(ctx context.Context, code string) (*UserInfo, error) {
	token, err := d.config.Exchange(ctx, code)
	if err != nil {
		return nil, fmt.Errorf("discord token exchange failed: %w", err)
	}

	client := d.config.Client(ctx, token)
	resp, err := client.Get("https://discord.com/api/users/@me")
	if err != nil {
		return nil, fmt.Errorf("failed to get discord user info: %w", err)
	}
	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		return nil, fmt.Errorf("discord user API returned status %d", resp.StatusCode)
	}

	body, err := io.ReadAll(resp.Body)
	if err != nil {
		return nil, fmt.Errorf("failed to read discord response: %w", err)
	}

	var discordUser struct {
		ID            string `json:"id"`
		Username      string `json:"username"`
		Email         string `json:"email"`
		Avatar        string `json:"avatar"`
		Discriminator string `json:"discriminator"`
	}
	if err := json.Unmarshal(body, &discordUser); err != nil {
		return nil, fmt.Errorf("failed to parse discord user info: %w", err)
	}

	var avatarURL string
	if discordUser.Avatar != "" {
		avatarURL = fmt.Sprintf("https://cdn.discordapp.com/avatars/%s/%s.png", discordUser.ID, discordUser.Avatar)
	}

	return &UserInfo{
		Email:      discordUser.Email,
		Name:       discordUser.Username,
		AvatarURL:  avatarURL,
		ProviderID: discordUser.ID,
	}, nil
}
