package database

import (
	"context"
	"time"

	"github.com/google/uuid"
	"github.com/uptrace/bun"
)

// User represents a user in the system
type User struct {
	bun.BaseModel `bun:"table:users,alias:u"`

	ID                       string     `bun:"id,pk,type:char(36)"`
	Email                    string     `bun:"email,notnull,unique"`
	PasswordHash             string     `bun:"password_hash,notnull"`
	EmailVerified            bool       `bun:"email_verified,notnull,default:false"`
	EmailVerificationToken   *string    `bun:"email_verification_token"`
	EmailVerificationSentAt  *time.Time `bun:"email_verification_sent_at,type:datetime"`
	CreatedAt                time.Time  `bun:"created_at,notnull,default:current_timestamp"`
	UpdatedAt                time.Time  `bun:"updated_at,notnull,default:current_timestamp"`
{{if .HasOAuth}}	AuthProvider             string     `bun:"auth_provider,notnull,default:'local'"`
	ProviderUserID           string     `bun:"provider_user_id"`
{{end}}}

var _ bun.BeforeAppendModelHook = (*User)(nil)

// BeforeAppendModel implements bun.BeforeAppendModelHook
func (u *User) BeforeAppendModel(ctx context.Context, query bun.Query) error {
	switch query.(type) {
	case *bun.InsertQuery:
		if u.ID == "" {
			u.ID = uuid.New().String()
		}
		now := time.Now()
		if u.CreatedAt.IsZero() {
			u.CreatedAt = now
		}
		if u.UpdatedAt.IsZero() {
			u.UpdatedAt = now
		}
	case *bun.UpdateQuery:
		u.UpdatedAt = time.Now()
	}
	return nil
}

// RefreshToken represents a refresh token stored in the database
type RefreshToken struct {
	bun.BaseModel `bun:"table:refresh_tokens,alias:rt"`

	ID        int64      `bun:"id,pk,autoincrement"`
	UserID    string     `bun:"user_id,notnull,type:char(36)"`
	TokenHash string     `bun:"token_hash,notnull,unique"`
	ExpiresAt time.Time  `bun:"expires_at,notnull,type:datetime"`
	CreatedAt time.Time  `bun:"created_at,notnull,default:current_timestamp"`
	RevokedAt *time.Time `bun:"revoked_at,type:datetime"`

	User *User `bun:"rel:belongs-to,join:user_id=id"`
}

// IsRevoked returns true if the token has been revoked
func (rt *RefreshToken) IsRevoked() bool {
	return rt.RevokedAt != nil
}

// IsExpired returns true if the token has expired
func (rt *RefreshToken) IsExpired() bool {
	return time.Now().After(rt.ExpiresAt)
}

// IsValid returns true if the token is neither revoked nor expired
func (rt *RefreshToken) IsValid() bool {
	return !rt.IsRevoked() && !rt.IsExpired()
}
